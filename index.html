<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>O IMPOSTOR PRO üî™</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --primary: #e74c3c; --bg: #0f0f1a; --card: #1c1c2d; }
        body { background: var(--bg); color: #fff; font-family: 'Segoe UI', Arial, sans-serif; margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; overflow: hidden; }
        #game-container { background: var(--card); width: 95%; max-width: 500px; padding: 25px; border-radius: 30px; border: 3px solid #3b3b55; position: relative; box-sizing: border-box; }
        .config-icon { position: absolute; top: -55px; right: 5px; font-size: 32px; cursor: pointer; background: var(--card); padding: 10px; border-radius: 50%; border: 2px solid #3b3b55; z-index: 100; }
        .screen { display: none; flex-direction: column; gap: 12px; }
        .active { display: flex !important; }
        input, select { width: 100%; padding: 15px; border-radius: 12px; border: none; background: #2a2a40; color: #fff; font-size: 16px; box-sizing: border-box; outline: none; }
        button { width: 100%; padding: 18px; border-radius: 12px; border: none; background: #7289da; color: white; font-weight: bold; font-size: 16px; cursor: pointer; }
        
        .tab-container { display: flex; gap: 5px; margin-bottom: 15px; }
        .tab-btn { flex: 1; padding: 10px; background: #3b3b55; border-radius: 10px; font-size: 11px; cursor: pointer; text-align: center; }
        .active-tab { background: var(--primary) !important; }

        .color-row { display: flex; justify-content: space-between; align-items: center; background: #1c1c2d; padding: 12px; border-radius: 12px; margin-bottom: 5px; border: 1px solid #444; cursor: pointer; }
        .color-rainbow { background: linear-gradient(to right, red, orange, yellow, green, blue, indigo, violet); -webkit-background-clip: text; color: transparent; animation: rainbow 2s infinite; font-weight: bold; }
        @keyframes rainbow { 0%{filter: hue-rotate(0deg)} 100%{filter: hue-rotate(360deg)} }
        .color-gold { color: #f1c40f; text-shadow: 0 0 5px gold; font-weight: bold; }
        .name-black { background-color: #000; color: #fff !important; padding: 2px 5px; border-radius: 4px; border: 1px solid #555; }

        #chat-box { height: 180px; overflow-y: auto; background: #0a0a14; padding: 10px; border-radius: 15px; border: 2px solid #3b3b55; margin-bottom: 5px; }
        .msg { margin-bottom: 5px; font-size: 14px; }
    </style>
</head>
<body>

    <div id="game-container">
        <div class="config-icon" onclick="toggleSettings()">‚öôÔ∏è</div>

        <div id="settings-panel" style="display:none; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:90%; background:#2a2a40; padding:20px; border-radius:20px; z-index:500; border:2px solid #fff;">
            <div class="tab-container">
                <div class="tab-btn active-tab" id="btn-col" onclick="switchTab('colors')">LOJA</div>
                <div class="tab-btn" id="btn-lan" onclick="switchTab('lang')">PA√çS</div>
            </div>
            <div id="tab-colors">
                <p>üí∞ Moedas: <span id="my-money">0</span></p>
                <div class="color-row" onclick="setColor('white')"><span>Branco</span> <span style="color:green">Gr√°tis</span></div>
                <div class="color-row" onclick="setColor('black')"><span>Preto</span> <span style="color:green">Gr√°tis</span></div>
                <div class="color-row" onclick="buyColor('gold', 200)"><span class="color-gold">Dourado ‚ú®</span> <span>200üí∞</span></div>
                <div class="color-row" onclick="buyColor('rainbow', 400)"><span class="color-rainbow">Colorido üåà</span> <span>400üí∞</span></div>
            </div>
            <div id="tab-lang" style="display:none;">
                <select id="country-select" onchange="myCountry = this.value">
                    <option value="üáßüá∑">Brasil üáßüá∑</option>
                    <option value="üá∫üá∏">USA üá∫üá∏</option>
                    <option value="üáØüáµ">Japan üáØüáµ</option>
                </select>
            </div>
            <button onclick="toggleSettings()" style="background:var(--primary); margin-top:10px">OK</button>
        </div>

        <div id="setup-screen" class="screen active">
            <h1 style="text-align: center; color: var(--primary);">O IMPOSTOR PRO</h1>
            <input type="text" id="player-name" placeholder="Seu Nome">
            
            <div style="background:#1c1c2d; padding:15px; border-radius:15px; border: 1px solid #e74c3c;">
                <select id="max-players">
                    <option value="2">2 JOGADORES (X1)</option>
                    <option value="3" selected>3 JOGADORES</option>
                    <option value="5">5 JOGADORES</option>
                </select>
                <input type="password" id="room-pass" placeholder="üîí Senha Obrigat√≥ria">
                <button onclick="setupHost()" style="background:#27ae60; margin-top:10px">CRIAR SALA</button>
            </div>

            <div style="background:#1c1c2d; padding:15px; border-radius:15px; margin-top:10px">
                <input type="text" id="join-id" placeholder="¬©Ô∏è C√≥digo da Sala">
                <input type="password" id="join-pass-input" placeholder="üîí Digite a Senha">
                <button id="join-btn" onclick="joinRoom()" style="margin-top:10px">ENTRAR</button>
            </div>
        </div>

        <div id="game-screen" class="screen">
            <div style="display:flex; justify-content:space-between; align-items:center">
                <span id="player-counter">1/--</span>
                <button onclick="leaveRoom()" style="width:auto; padding:8px 15px; font-size:11px; background:#c0392b">SAIR DA SALA</button>
            </div>
            <div id="chat-box"></div>
            <div style="display:flex; gap:5px">
                <input type="text" id="chat-input" placeholder="Chat...">
                <button onclick="sendMsg()" style="width:60px; background:#f39c12">OK</button>
            </div>
            <button id="voice-btn" onclick="toggleVoice()" style="background:#444; height:65px">VOICE: DESLIGADO üîá</button>
            <button onclick="copyCode()" style="background:#34495e; padding:10px; font-size:12px">COPIAR C√ìDIGO ¬©Ô∏è</button>
        </div>
    </div>

<script>
    let peer = new Peer(), conn, myStream, isHost = false, players = [], maxP = 2, micActive = false;
    let myColor = 'white', myCountry = 'üáßüá∑', myCoins = parseInt(localStorage.getItem('coins')) || 0;
    let roomPassword = "";

    document.getElementById('my-money').innerText = myCoins;

    function toggleSettings() {
        const s = document.getElementById('settings-panel');
        s.style.display = s.style.display === 'none' ? 'block' : 'none';
    }

    function switchTab(tab) {
        document.getElementById('tab-colors').style.display = tab === 'colors' ? 'block' : 'none';
        document.getElementById('tab-lang').style.display = tab === 'lang' ? 'block' : 'none';
    }

    async function initVoice() {
        try {
            myStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            myStream.getAudioTracks()[0].enabled = false;
            peer.on('call', call => {
                call.answer(myStream);
                call.on('stream', s => { const a = new Audio(); a.srcObject = s; a.play(); });
            });
        } catch(e) { console.log("Erro mic"); }
    }

    function toggleVoice() {
        if(!myStream) return;
        micActive = !micActive;
        myStream.getAudioTracks()[0].enabled = micActive;
        const btn = document.getElementById('voice-btn');
        btn.style.background = micActive ? '#27ae60' : '#444';
        btn.innerText = micActive ? "VOICE: LIGADO üé§" : "VOICE: DESLIGADO üîá";
    }

    async function setupHost() {
        roomPassword = document.getElementById('room-pass').value;
        if(!roomPassword) { alert("Senha obrigat√≥ria!"); return; }
        await initVoice();
        isHost = true;
        maxP = parseInt(document.getElementById('max-players').value);
        showScreen('game-screen');
        updateCounter(1, maxP);
        peer.on('connection', c => {
            c.on('data', data => {
                if(data.type === 'auth') {
                    if(data.pass === roomPassword) {
                        players.push({id: c.peer, conn: c});
                        c.send({type:'auth_ok', max: maxP});
                        setTimeout(() => peer.call(c.peer, myStream), 1000);
                        updateCounter(players.length + 1, maxP);
                    } else { c.send({type:'auth_fail'}); }
                }
                if(data.type === 'chat') broadcast({type:'chat', ...data});
            });
        });
        alert("C√ìDIGO: " + peer.id);
    }

    async function joinRoom() {
        const id = document.getElementById('join-id').value.trim();
        const pass = document.getElementById('join-pass-input').value;
        const btn = document.getElementById('join-btn');
        
        if(!id || !pass) { alert("Preencha C√≥digo e Senha!"); return; }
        
        btn.innerText = "CONECTANDO...";
        btn.disabled = true;

        await initVoice();
        conn = peer.connect(id);

        conn.on('open', () => {
            conn.send({type:'auth', name: document.getElementById('player-name').value, pass: pass, country: myCountry, color: myColor});
        });

        conn.on('data', data => {
            if(data.type === 'auth_ok') {
                maxP = data.max;
                showScreen('game-screen');
            } else if(data.type === 'auth_fail') {
                alert("Senha Incorreta!");
                btn.innerText = "ENTRAR";
                btn.disabled = false;
            }
            if(data.type === 'chat') addMsg(data);
        });

        setTimeout(() => {
            if(document.getElementById('setup-screen').classList.contains('active')) {
                alert("Tempo esgotado. Verifique o c√≥digo!");
                btn.innerText = "ENTRAR";
                btn.disabled = false;
            }
        }, 8000);
    }

    function leaveRoom() { location.reload(); }

    function sendMsg() {
        const input = document.getElementById('chat-input');
        if(!input.value) return;
        const data = {name: document.getElementById('player-name').value, text: input.value, country: myCountry, color: myColor};
        if(isHost) broadcast({type:'chat', ...data}); else conn.send({type:'chat', ...data});
        input.value = "";
    }

    function addMsg(data) {
        const b = document.getElementById('chat-box');
        const cClass = data.color === 'rainbow' ? 'color-rainbow' : (data.color === 'black' ? 'name-black' : (data.color === 'gold' ? 'color-gold' : ''));
        const style = (!cClass) ? `style="color:${data.color}"` : '';
        b.innerHTML += `<div class="msg"><span>${data.country}</span> <b ${style} class="${cClass}">${data.name}:</b> ${data.text}</div>`;
        b.scrollTop = b.scrollHeight;
    }

    function broadcast(data) { addMsg(data); players.forEach(p => p.conn.send(data)); }
    function showScreen(s) { document.querySelectorAll('.screen').forEach(d => d.classList.remove('active')); document.getElementById(s).classList.add('active'); }
    function updateCounter(cur, max) { document.getElementById('player-counter').innerText = cur + "/" + max; }
    function copyCode() { navigator.clipboard.writeText(peer.id); alert("Copiado!"); }
    function setColor(c) { myColor = c; alert("Equipado!"); }
    function buyColor(c, p) { if(myCoins >= p) { myColor = c; alert("Comprado!"); } else alert("Moedas insuficientes!"); }
</script>
</body>
</html>
