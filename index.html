<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>INFILTRADO - VERS√ÉO PRO</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { background: #0f0f1a; color: #fff; font-family: 'Segoe UI', sans-serif; display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; }
        #game-container { background: #1c1c2d; width: 95%; max-width: 450px; padding: 25px; border-radius: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.7); border: 2px solid #3b3b55; box-sizing: border-box; }
        .active { display: block !important; }
        .screen { display: none; }
        input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 10px; border: none; background: #2a2a40; color: #fff; box-sizing: border-box; font-size: 16px; }
        button { width: 100%; padding: 14px; border-radius: 10px; border: none; background: #7289da; color: white; font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 16px; }
        button.host { background: #43b581; }
        button.imp-btn { background: #e74c3c; margin-top: 5px; font-size: 12px; }
        #chat-box { height: 250px; overflow-y: auto; background: #0f0f1a; padding: 15px; border-radius: 10px; margin: 15px 0; border: 1px solid #3b3b55; }
        .msg { margin-bottom: 10px; line-height: 1.4; border-bottom: 1px solid #222; padding-bottom: 5px; word-wrap: break-word; }
        .msg.sys { color: #f1c40f; font-weight: bold; }
        .role-area { padding: 15px; border-radius: 10px; text-align: center; font-weight: bold; margin-bottom: 10px; font-size: 18px; transition: 0.5s; }
        #timer { font-size: 24px; text-align: center; color: #ff4757; font-weight: bold; }
        #replay-section { display: none; background: #2d2d44; padding: 15px; border-radius: 10px; text-align: center; margin-top: 10px; }
    </style>
</head>
<body>

    <div id="game-container">
        <div id="setup-screen" class="screen active">
            <h1 style="text-align: center; color: #f39c12;">üïµÔ∏è Infiltrado</h1>
            <input type="text" id="player-name" placeholder="Seu Nome (M√°x 20)" maxlength="20">
            <button class="host" onclick="setupHost()">CRIAR SALA</button>
            <div style="margin-top: 20px;">
                <input type="text" id="join-id" placeholder="ID da Sala">
                <input type="password" id="join-pass" placeholder="Senha da Sala">
                <button onclick="joinRoom()">ENTRAR NO JOGO</button>
            </div>
        </div>

        <div id="game-screen" class="screen">
            <div id="timer">05:00</div>
            <div id="role-display" class="role-area" style="background: #34495e;">AGUARDANDO JOGADORES...</div>
            
            <button id="btn-guess" class="imp-btn" onclick="impostorGuess()" style="display:none;">ADIVINHAR PALAVRA üí°</button>
            <button id="btn-start-manual" onclick="startGame()" style="display:none; background:#f39c12;">COME√áAR COM 2 JOGADORES</button>

            <div id="chat-box"></div>
            
            <div id="input-area" style="display: flex; gap: 5px;">
                <input type="text" id="chat-input" placeholder="Escreva aqui...">
                <button onclick="sendMsg()" style="width:90px; background:#f39c12;">ENVIAR</button>
            </div>

            <div id="replay-section">
                <p id="replay-status">Jogar de novo? (0/0)</p>
                <button id="btn-replay" onclick="voteReplay()" style="background: #27ae60;">QUERO REVANCHE</button>
            </div>
            
            <button id="copy-btn" style="background: #555; font-size: 11px; margin-top: 15px;" onclick="copyLink()">üìã COPIAR LINK</button>
        </div>
    </div>

<script>
    let peer = new Peer();
    let conn, myId, isHost = false, amIImpostor = false;
    let roomPass = "", players = [], replayVotes = 0;
    let words = ["TELEVIS√ÉO", "CAF√â", "CELULAR", "PIZZA", "CADEIRA", "SAPATO", "GELADEIRA"];
    let currentWord = "", gameActive = false, timerId;

    peer.on('open', id => myId = id);

    function setupHost() {
        const p = prompt("Senha da sala:");
        if(!p) return;
        roomPass = p; isHost = true;
        showScreen('game-screen');
        peer.on('connection', c => {
            c.on('data', data => {
                if(data.type === 'auth') {
                    if(data.pass === roomPass) {
                        players.push({id: c.peer, name: data.name.substring(0,20), conn: c});
                        c.send({type: 'auth_ok'});
                        addMsg("SISTEMA", data.name + " entrou!");
                        updateLobby();
                    } else c.send({type: 'auth_fail'});
                }
                if(data.type === 'chat') relayMsg(data.name, data.text);
                if(data.type === 'replay_vote') handleReplayVote();
                if(data.type === 'guess') checkGuess(data.word, data.name);
            });
        });
    }

    function joinRoom() {
        const hostId = document.getElementById('join-id').value;
        const pass = document.getElementById('join-pass').value;
        const name = document.getElementById('player-name').value || "Jogador";
        conn = peer.connect(hostId);
        conn.on('open', () => conn.send({type: 'auth', pass: pass, name: name.substring(0,20)}));
        conn.on('data', data => {
            if(data.type === 'auth_ok') showScreen('game-screen');
            if(data.type === 'auth_fail') alert("Senha incorreta!");
            if(data.type === 'start') handleStart(data);
            if(data.type === 'chat') addMsg(data.name, data.text);
            if(data.type === 'end') endGame(data.msg, data.win);
            if(data.type === 'reset') resetClient();
            if(data.type === 'replay_status') document.getElementById('replay-status').innerText = `Jogar de novo? (${data.count}/${data.total})`;
        });
    }

    function updateLobby() {
        const count = players.length + 1;
        document.getElementById('role-display').innerText = `JOGADORES (${count}/3)`;
        if(count >= 2) document.getElementById('btn-start-manual').style.display = 'block';
        if(count === 3) startGame();
    }

    function startGame() {
        gameActive = true; replayVotes = 0;
        document.getElementById('btn-start-manual').style.display = 'none';
        currentWord = words[Math.floor(Math.random()*words.length)];
        const impIdx = Math.floor(Math.random() * (players.length + 1));
        amIImpostor = (impIdx === 0);
        
        applyRole(amIImpostor, currentWord);
        players.forEach((p, i) => {
            p.conn.send({type: 'start', isImp: (impIdx === i+1), word: currentWord});
        });
        startTimer();
    }

    function handleStart(data) {
        amIImpostor = data.isImp;
        applyRole(data.isImp, data.word);
        startTimer();
    }

    function applyRole(isImp, word) {
        const d = document.getElementById('role-display');
        d.innerText = isImp ? "VOC√ä √â O IMPOSTOR!" : "PALAVRA: " + word;
        d.style.background = isImp ? "#e74c3c" : "#27ae60";
        document.getElementById('btn-guess').style.display = isImp ? "block" : "none";
        document.getElementById('replay-section').style.display = 'none';
    }

    function impostorGuess() {
        const g = prompt("Qual √© a palavra secreta?").toUpperCase();
        if(!g) return;
        if(isHost) checkGuess(g, document.getElementById('player-name').value);
        else conn.send({type: 'guess', word: g, name: document.getElementById('player-name').value});
    }

    function checkGuess(g, name) {
        if(g === currentWord) {
            const m = `O IMPOSTOR (${name}) GANHOU! A palavra era ${currentWord}`;
            isHost ? relayEnd(m, true) : null;
        } else {
            const m = `O IMPOSTOR (${name}) ERROU! Ele disse ${g}. Inocentes venceram!`;
            isHost ? relayEnd(m, false) : null;
        }
    }

    function relayEnd(msg, impWin) {
        endGame(msg, impWin);
        players.forEach(p => p.conn.send({type: 'end', msg, win: impWin}));
    }

    function endGame(msg, impWin) {
        clearInterval(timerId);
        addMsg("SISTEMA", msg);
        document.getElementById('role-display').innerText = "FIM DE JOGO";
        document.getElementById('role-display').style.background = "#34495e";
        document.getElementById('replay-section').style.display = 'block';
        document.getElementById('btn-guess').style.display = 'none';
        const total = players.length + 1;
        document.getElementById('replay-status').innerText = `Jogar de novo? (0/${total})`;
    }

    function voteReplay() {
        document.getElementById('btn-replay').disabled = true;
        if(isHost) handleReplayVote(); else conn.send({type: 'replay_vote'});
    }

    function handleReplayVote() {
        replayVotes++;
        const total = players.length + 1;
        const txt = `Jogar de novo? (${replayVotes}/${total})`;
        document.getElementById('replay-status').innerText = txt;
        players.forEach(p => p.conn.send({type: 'replay_status', count: replayVotes, total}));
        if(replayVotes >= total) {
            players.forEach(p => p.conn.send({type: 'reset'}));
            resetClient(); startGame();
        }
    }

    function resetClient() {
        clearInterval(timerId);
        document.getElementById('chat-box').innerHTML = "";
        document.getElementById('btn-replay').disabled = false;
        document.getElementById('timer').innerText = "05:00";
    }

    function startTimer() {
        clearInterval(timerId); let t = 300;
        timerId = setInterval(() => {
            if(t > 0) { t--; let m = Math.floor(t/60), s = t%60;
                document.getElementById('timer').innerText = `${m}:${s<10?'0':''}${s}`;
            } else { clearInterval(timerId); if(isHost) relayEnd("O TEMPO ACABOU! Inocentes venceram!", false); }
        }, 1000);
    }

    function sendMsg() {
        const i = document.getElementById('chat-input');
        if(!i.value.trim()) return;
        const n = document.getElementById('player-name').value || "Anon";
        if(isHost) relayMsg(n, i.value); else conn.send({type: 'chat', name: n, text: i.value});
        i.value = "";
    }
    function relayMsg(n, t) { addMsg(n, t); if(isHost) players.forEach(p => p.conn.send({type: 'chat', name: n, text: t})); }
    function addMsg(n, t) {
        const b = document.getElementById('chat-box');
        b.innerHTML += `<div class="msg ${n==='SISTEMA'?'sys':''}"><b>${n}:</b> ${t}</div>`;
        b.scrollTop = b.scrollHeight;
    }
    function showScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
    function copyLink() { navigator.clipboard.writeText(window.location.href.split('?')[0] + "?room=" + myId); alert("Link copiado!"); }
    document.getElementById('chat-input').onkeypress = e => { if(e.key==='Enter') sendMsg() };
</script>
</body>
</html>
